%% 使用流程图：从 .proto 文件到最终使用的完整流程
sequenceDiagram
    participant User as 用户代码
    participant Proto as .proto 文件
    participant PJS as protobuf.js
    participant PRS as protobuf-rs
    participant Rust as Rust Core
    participant Mem as 内存池

    Note over User,Mem: 阶段1: Schema定义和加载
    User->>Proto: 定义消息结构
    Proto->>PJS: 加载和解析 .proto
    PJS->>PJS: 生成类型和验证器

    Note over User,Mem: 阶段2: 消息编码（写入）
    User->>PRS: encode(message)
    PRS->>Mem: 获取缓冲区
    Mem-->>PRS: 返回可复用缓冲区
    PRS->>Rust: Writer操作
    Rust->>Rust: varint编码（SIMD优化）
    Rust->>Rust: 字段标签编码
    Rust-->>PRS: 返回编码数据
    PRS-->>User: 返回Buffer

    Note over User,Mem: 阶段3: 消息解码（读取）
    User->>PRS: decode(buffer)
    PRS->>Rust: Reader操作（零拷贝）
    Rust->>Rust: varint解码（SIMD批处理）
    Rust->>Rust: 字段解析
    Rust-->>PRS: 返回解码数据
    PRS->>PJS: 类型验证和转换
    PJS-->>PRS: 验证通过
    PRS-->>User: 返回JavaScript对象

    Note over User,Mem: 阶段4: 资源清理
    PRS->>Mem: 归还缓冲区
    Mem->>Mem: 缓冲区复用

    rect rgb(144, 238, 144)
        Note right of Rust: 性能关键路径<br/>• 零拷贝读取<br/>• SIMD批处理<br/>• 内存池复用<br/>• AOT编译优化
    end
